name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: Set up Go
      uses: actions/setup-go@v3
      with:
        go-version: '1.20'
    
    - name: Build Rust components
      run: |
        cd buildtree
        cargo build --release
    
    - name: Build Go components
      run: |
        cd cmd/tui
        go build -o mytui
    
    - name: Build C components
      run: |
        gcc fake_hex.c -o fake_hex
        gcc launcher.c -o launch
    
    - name: Make scripts executable
      run: |
        chmod +x play 01_read_config.py 02_find_m4s.py 03_detect_av.py 04_play.py
    
    - name: Create release archive
      run: |
        mkdir -p biliCLI-linux-amd64/buildtree/target/release
        mkdir -p biliCLI-linux-amd64/cmd/tui
        cp -r buildtree/target/release/buildtree biliCLI-linux-amd64/buildtree/target/release/
        cp cmd/tui/mytui biliCLI-linux-amd64/cmd/tui/
        cp play fake_hex launch biliCLI-linux-amd64/
        cp 01_read_config.py 02_find_m4s.py 03_detect_av.py 04_play.py biliCLI-linux-amd64/
        cp config.json biliCLI-linux-amd64/
        cp README.md LICENSE biliCLI-linux-amd64/
        tar -czf biliCLI-linux-amd64.tar.gz biliCLI-linux-amd64
    
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v3
      with:
        name: biliCLI-linux-amd64
        path: biliCLI-linux-amd64.tar.gz

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: Set up Go
      uses: actions/setup-go@v3
      with:
        go-version: '1.20'
    
    - name: Build Rust components
      run: |
        cd buildtree
        cargo build --release
    
    - name: Build Go components
      run: |
        cd cmd/tui
        go build -o mytui
    
    - name: Build C components
      run: |
        gcc fake_hex.c -o fake_hex
        gcc launcher.c -o launch
    
    - name: Make scripts executable
      run: |
        chmod +x play 01_read_config.py 02_find_m4s.py 03_detect_av.py 04_play.py
    
    - name: Create release archive
      run: |
        mkdir -p biliCLI-darwin-amd64/buildtree/target/release
        mkdir -p biliCLI-darwin-amd64/cmd/tui
        cp buildtree/target/release/buildtree biliCLI-darwin-amd64/buildtree/target/release/
        cp cmd/tui/mytui biliCLI-darwin-amd64/cmd/tui/
        cp play fake_hex launch biliCLI-darwin-amd64/
        cp 01_read_config.py 02_find_m4s.py 03_detect_av.py 04_play.py biliCLI-darwin-amd64/
        cp config.json biliCLI-darwin-amd64/
        cp README.md LICENSE biliCLI-darwin-amd64/
        tar -czf biliCLI-darwin-amd64.tar.gz biliCLI-darwin-amd64
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v3
      with:
        name: biliCLI-darwin-amd64
        path: biliCLI-darwin-amd64.tar.gz

  release:
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Download all artifacts
      uses: actions/download-artifact@v3
    
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false
        body: |
          ğŸµ biliCLI é¢„ç¼–è¯‘ç‰ˆæœ¬
          
          ## âœ¨ æ–°åŠŸèƒ½
          - å…ç¼–è¯‘å®‰è£…ï¼Œä¸‹è½½å³ç”¨
          - ä¸€é”®å®‰è£…è„šæœ¬æ”¯æŒ
          - å¤šå¹³å°é¢„ç¼–è¯‘äºŒè¿›åˆ¶
          
          ## ğŸ“¦ ä¸‹è½½è¯´æ˜
          - `biliCLI-linux-amd64.tar.gz` - Linux 64ä½ç‰ˆæœ¬
          - `biliCLI-darwin-amd64.tar.gz` - macOS 64ä½ç‰ˆæœ¬
          
          ## ğŸš€ å¿«é€Ÿå®‰è£…
          ```bash
          # ä¸‹è½½å¹¶è§£å‹
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref }}/biliCLI-linux-amd64.tar.gz
          tar -xzf biliCLI-linux-amd64.tar.gz
          cd biliCLI-linux-amd64
          
          # ç¼–è¾‘é…ç½®
          nano config.json
          
          # è¿è¡Œ
          ./launch
          ```
          
          ## âš ï¸ ç³»ç»Ÿè¦æ±‚
          - Linux/macOS 64ä½ç³»ç»Ÿ
          - ffplay (ffmpeg)
          - Python 3.8+
          - xxd (é€šå¸¸å·²é¢„è£…)
          
          ## ğŸ”§ ä¸€é”®å®‰è£…
          ```bash
          curl -sSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash
          ```
    
    - name: Upload Linux Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./biliCLI-linux-amd64/biliCLI-linux-amd64.tar.gz
        asset_name: biliCLI-linux-amd64.tar.gz
        asset_content_type: application/gzip
    
    - name: Upload macOS Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./biliCLI-darwin-amd64/biliCLI-darwin-amd64.tar.gz
        asset_name: biliCLI-darwin-amd64.tar.gz
        asset_content_type: application/gzip
#!/bin/bash
set -e

if [[ $# -ne 1 ]]; then
    echo "用法: $0 <CID>" >&2
    exit 1
fi
CID="$1"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TREE_JSON="$SCRIPT_DIR/buildtree/tree.json"

if [[ ! -f "$TREE_JSON" ]]; then
    echo "错误: 找不到 tree.json 文件！" >&2
    exit 1
fi

TAB_NAME=$(python3 -c "
import json, sys
with open(sys.argv[1], 'r', encoding='utf-8') as f:
    data = json.load(f)

for item in data:
    for title in item.get('titles', []):
        for tab in title.get('tabs', []):
            for it in tab.get('items', []):
                if str(it.get('cid')) == sys.argv[2]:
                    tab_name = tab.get('name', '')
                    title_name = title.get('name', '')

                    if tab_name == title_name:
                        print(f\"{tab_name}\")
                    else:
                        print(f\"{title_name}:{tab_name}\")
                    exit()

print('未知曲目')
" "$TREE_JSON" "$CID")

# === 清屏并初始化 ===
clear
LINES=$(tput lines)
STATUS_LINE=$((LINES - 1))

echo "正在加载音频流..."
echo ""

ROOT=$($SCRIPT_DIR/01_read_config.py)

# 找到第一个音频文件
AUDIO_FILE=""
while IFS= read -r -d '' f; do
    TYPE=$(printf '%s' "$f" | $SCRIPT_DIR/03_detect_av.py)
    [[ $TYPE == Video ]] && continue
    AUDIO_FILE="$f"
    break
done < <(find "$ROOT/$CID" -name '*-*.m4s' -print0)

if [[ -z "$AUDIO_FILE" ]]; then
    echo "未找到音频文件" >&2
    exit 1
fi

# ===== 启动氛围刷屏任务 =====
"$SCRIPT_DIR/fake_hex" "$AUDIO_FILE" "$TAB_NAME" &
FAKE_PID=$!

# ===== 播放音频（后台）=====
tail -c +10 "$AUDIO_FILE" | ffplay -v 0 -nostats -nodisp -autoexit - 2>/dev/null &
FFPLAY_PID=$!

# ===== 监听键盘输入 =====
PAUSED=false
echo -e "\n▶ 正在播放: $TAB_NAME\n按 p 暂停/继续，按 x 退出..."

while kill -0 "$FFPLAY_PID" 2>/dev/null; do
    if read -s -n1 -t 0.1 key;then
    case "$key" in
        'p'|'P')
            if [ "$PAUSED" = false ]; then
                # 暂停音频和刷屏
                kill -STOP "$FFPLAY_PID" 2>/dev/null
                kill -STOP "$FAKE_PID"   2>/dev/null
                PAUSED=true
                echo -e "\n已暂停，按 p 继续..."
            else
                # 恢复音频和刷屏
                kill -CONT "$FFPLAY_PID" 2>/dev/null
                kill -CONT "$FAKE_PID"   2>/dev/null
                PAUSED=false
                echo -e "\n继续播放: $TAB_NAME"
            fi
            ;;
        'x'|'X')
            echo -e "\n用户主动退出"
            # 先尝试正常终止，再强制清理
            kill "$FFPLAY_PID" 2>/dev/null
            kill "$FAKE_PID"  2>/dev/null
            break
            ;;
    esac
    fi
done

# ===== 清理 =====
kill "$FAKE_PID" 2>/dev/null || true
wait "$FAKE_PID" 2>/dev/null || true
wait "$FFPLAY_PID" 2>/dev/null || true

exit 0
